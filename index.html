<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RK LOGIX HUB - Client CRM</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    .card { border: 1px solid #e5e7eb; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.04); }
    .btn { border-radius: 12px; padding: 10px 14px; font-weight: 600; }
    .btn-primary { background: #111827; color: white; }
    .btn-outline { border: 1px solid #111827; color: #111827; background: white; }
    .input { width: 100%; border: 1px solid #d1d5db; border-radius: 12px; padding: 10px 12px; }
    .label { font-size: 12px; font-weight: 700; color: #374151; }
    .muted { color: #6b7280; }
    .pill { border: 1px solid #e5e7eb; padding: 4px 10px; border-radius: 999px; font-size: 12px; }
    .hidden { display: none; }
  </style>
</head>

<body class="bg-gray-50 text-gray-900">
  <header class="px-5 py-4 bg-white border-b">
    <div class="max-w-6xl mx-auto flex items-center justify-between gap-4">
      <div>
        <div class="text-xl font-extrabold">RK LOGIX HUB</div>
        <div class="text-sm muted">Client Registration • Follow-ups • Load Assignment • BOL Storage</div>
      </div>

      <div class="flex items-center gap-2">
        <span id="sessionPill" class="pill hidden"></span>
        <button id="btnLogin" class="btn btn-primary">Employee Login</button>
        <button id="btnLogout" class="btn btn-outline hidden">Logout</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-5 py-6 space-y-6">

    <!-- STATUS / ALERT -->
    <div id="alert" class="hidden card p-4 bg-white">
      <div class="flex items-start justify-between gap-4">
        <div>
          <div id="alertTitle" class="font-bold"></div>
          <div id="alertMsg" class="text-sm muted mt-1"></div>
        </div>
        <button class="btn btn-outline" onclick="hideAlert()">Close</button>
      </div>
    </div>

    <!-- QUICK NAV -->
    <div class="card p-4 bg-white">
      <div class="flex flex-wrap gap-2">
        <button class="btn btn-outline" onclick="scrollToId('registerSection')">Register Client</button>
        <button class="btn btn-outline" onclick="scrollToId('viewClientsSection')">View Client Data</button>
        <button class="btn btn-outline" onclick="scrollToId('contactTrackingSection')">Contact Tracking</button>
      </div>
      <div class="text-sm muted mt-2">
        Note: Data operations require employee login (Supabase Auth). PDFs are stored privately in Supabase Storage.
      </div>
    </div>

    <!-- REGISTER CLIENT -->
    <section id="registerSection" class="card p-5 bg-white">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h2 class="text-lg font-extrabold">Register Client</h2>
          <p class="text-sm muted mt-1">Register Shipper and Receiver into separate tables for future business and search.</p>
        </div>
        <div class="pill">Tables: shippers • receivers</div>
      </div>

      <div class="mt-5 grid md:grid-cols-2 gap-4">
        <!-- Shipper -->
        <div class="card p-4 bg-gray-50">
          <div class="font-extrabold">Shipper Registration</div>
          <form id="shipperForm" class="mt-3 space-y-3">
            <div>
              <div class="label">Company Name</div>
              <input class="input" name="company_name" required />
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <div class="label">Contact Name</div>
                <input class="input" name="contact_name" />
              </div>
              <div>
                <div class="label">Phone</div>
                <input class="input" name="phone" />
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <div class="label">Email</div>
                <input class="input" name="email" type="email" />
              </div>
              <div>
                <div class="label">Company Website</div>
                <input class="input" name="company_website" />
              </div>
            </div>

            <div class="label">Street Address</div>
            <input class="input" name="street_address" />

            <div class="grid grid-cols-2 gap-3">
              <div>
                <div class="label">City</div>
                <input class="input" name="city" />
              </div>
              <div>
                <div class="label">State/Province</div>
                <input class="input" name="state_province" />
              </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
              <div>
                <div class="label">Country</div>
                <input class="input" name="country" />
              </div>
              <div>
                <div class="label">Postal Code</div>
                <input class="input" name="postal_code" />
              </div>
            </div>

            <div>
              <div class="label">Load Description</div>
              <input class="input" name="load_description" />
            </div>
            <div>
              <div class="label">Preferred Trailer Type</div>
              <input class="input" name="preferred_trailer_type" placeholder="Dry Van / Reefer / Flatbed..." />
            </div>

            <div class="flex gap-2 pt-2">
              <button class="btn btn-primary" type="submit">Save Shipper</button>
              <button class="btn btn-outline" type="button" onclick="document.getElementById('shipperForm').reset()">Clear</button>
            </div>
          </form>
        </div>

        <!-- Receiver -->
        <div class="card p-4 bg-gray-50">
          <div class="font-extrabold">Receiver Registration</div>
          <form id="receiverForm" class="mt-3 space-y-3">
            <div>
              <div class="label">Company Name</div>
              <input class="input" name="company_name" required />
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <div class="label">Contact Name</div>
                <input class="input" name="contact_name" />
              </div>
              <div>
                <div class="label">Phone</div>
                <input class="input" name="phone" />
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <div class="label">Email</div>
                <input class="input" name="email" type="email" />
              </div>
              <div>
                <div class="label">Company Website</div>
                <input class="input" name="company_website" />
              </div>
            </div>

            <div class="label">Street Address</div>
            <input class="input" name="street_address" />

            <div class="grid grid-cols-2 gap-3">
              <div>
                <div class="label">City</div>
                <input class="input" name="city" />
              </div>
              <div>
                <div class="label">State/Province</div>
                <input class="input" name="state_province" />
              </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
              <div>
                <div class="label">Country</div>
                <input class="input" name="country" />
              </div>
              <div>
                <div class="label">Postal Code</div>
                <input class="input" name="postal_code" />
              </div>
            </div>

            <div>
              <div class="label">Load Description</div>
              <input class="input" name="load_description" />
            </div>
            <div>
              <div class="label">Preferred Trailer Type</div>
              <input class="input" name="preferred_trailer_type" placeholder="Dry Van / Reefer / Flatbed..." />
            </div>

            <div class="flex gap-2 pt-2">
              <button class="btn btn-primary" type="submit">Save Receiver</button>
              <button class="btn btn-outline" type="button" onclick="document.getElementById('receiverForm').reset()">Clear</button>
            </div>
          </form>
        </div>
      </div>
    </section>

    <!-- VIEW CLIENTS -->
    <section id="viewClientsSection" class="card p-5 bg-white">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h2 class="text-lg font-extrabold">View Client Data</h2>
          <p class="text-sm muted mt-1">Loads from <b>clients_view</b> (combined shipper + receiver).</p>
        </div>
        <div class="flex gap-2">
          <button class="btn btn-outline" onclick="loadClients()">Refresh Data</button>
        </div>
      </div>

      <div class="mt-4 grid md:grid-cols-4 gap-3">
        <div>
          <div class="label">Client Type</div>
          <select id="filterClientType" class="input">
            <option value="">All</option>
            <option value="shipper">Shipper</option>
            <option value="receiver">Receiver</option>
          </select>
        </div>
        <div>
          <div class="label">Country</div>
          <input id="filterCountry" class="input" placeholder="Canada / USA" />
        </div>
        <div>
          <div class="label">State/Province</div>
          <input id="filterState" class="input" placeholder="ON / NY ..." />
        </div>
        <div>
          <div class="label">Trailer Type</div>
          <input id="filterTrailer" class="input" placeholder="Dry Van / Reefer ..." />
        </div>
      </div>

      <div class="mt-4 overflow-auto">
        <table class="min-w-full text-sm">
          <thead class="text-left">
            <tr class="border-b">
              <th class="py-2 pr-4">Type</th>
              <th class="py-2 pr-4">Company</th>
              <th class="py-2 pr-4">Contact</th>
              <th class="py-2 pr-4">Phone</th>
              <th class="py-2 pr-4">Email</th>
              <th class="py-2 pr-4">City</th>
              <th class="py-2 pr-4">State</th>
              <th class="py-2 pr-4">Country</th>
              <th class="py-2 pr-4">Trailer</th>
              <th class="py-2 pr-4">Created</th>
            </tr>
          </thead>
          <tbody id="clientsTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- CONTACT TRACKING -->
    <section id="contactTrackingSection" class="card p-5 bg-white">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h2 class="text-lg font-extrabold">Contact Tracking</h2>
          <p class="text-sm muted mt-1">Record each follow-up. Assign a load and upload BOL PDF when applicable.</p>
        </div>
        <div class="pill">Tables: contact_tracking • loads • Storage: load-documents</div>
      </div>

      <div class="mt-5 grid md:grid-cols-2 gap-4">
        <div class="card p-4 bg-gray-50">
          <div class="font-extrabold">Record Follow-up</div>

          <div class="mt-3 space-y-3">
            <div>
              <div class="label">Client</div>
              <select id="clientSelect" class="input">
                <option value="">Load clients… (click Refresh Clients)</option>
              </select>
              <div class="text-xs muted mt-1">Tip: Click “Refresh Data” in View Client Data first, then come here.</div>
            </div>

            <div>
              <div class="label">Contact Methods</div>
              <div class="flex flex-wrap gap-3 mt-2 text-sm">
                <label class="flex items-center gap-2"><input type="checkbox" class="cm" value="Email"/> Email</label>
                <label class="flex items-center gap-2"><input type="checkbox" class="cm" value="Phone Call"/> Phone Call</label>
                <label class="flex items-center gap-2"><input type="checkbox" class="cm" value="Social Media"/> Social Media</label>
                <label class="flex items-center gap-2"><input type="checkbox" class="cm" value="WhatsApp"/> WhatsApp</label>
              </div>
            </div>

            <div>
              <div class="label">Remarks</div>
              <textarea id="remarks" class="input" rows="4" placeholder="Write follow-up notes..."></textarea>
            </div>

            <div class="flex gap-2 pt-2">
              <button class="btn btn-primary" onclick="saveContact()">Record Contact</button>
              <button class="btn btn-outline" onclick="openLoadAssignModal()">Load Assigned</button>
            </div>

            <div class="text-xs muted">
              Load Assigned workflow: creates load → uploads PDF → updates load bol_pdf_path → links last contact with load_id.
            </div>
          </div>
        </div>

        <div class="card p-4 bg-gray-50">
          <div class="font-extrabold">Recent Contact History</div>
          <div class="text-sm muted mt-1">Shows last 20 follow-ups (for quick validation).</div>
          <div class="mt-3 space-y-2" id="contactHistory"></div>
          <div class="mt-3">
            <button class="btn btn-outline" onclick="loadContactHistory()">Refresh History</button>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- LOGIN MODAL -->
  <div id="loginModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center p-4">
    <div class="bg-white card p-5 w-full max-w-md">
      <div class="flex items-start justify-between">
        <div>
          <div class="text-lg font-extrabold">Employee Login</div>
          <div class="text-sm muted">Use Supabase Auth email/password.</div>
        </div>
        <button class="btn btn-outline" onclick="closeModal('loginModal')">Close</button>
      </div>

      <div class="mt-4 space-y-3">
        <div>
          <div class="label">Email</div>
          <input id="loginEmail" class="input" type="email" placeholder="employee@rklogixhub.com" />
        </div>
        <div>
          <div class="label">Password</div>
          <input id="loginPassword" class="input" type="password" placeholder="••••••••" />
        </div>
        <button class="btn btn-primary w-full" onclick="login()">Login</button>
      </div>
    </div>
  </div>

  <!-- LOAD ASSIGN MODAL -->
  <div id="loadModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center p-4">
    <div class="bg-white card p-5 w-full max-w-xl">
      <div class="flex items-start justify-between">
        <div>
          <div class="text-lg font-extrabold">Load Assignment</div>
          <div class="text-sm muted">Enter load reference number and upload BOL PDF.</div>
        </div>
        <button class="btn btn-outline" onclick="closeModal('loadModal')">Close</button>
      </div>

      <div class="mt-4 space-y-3">
        <div>
          <div class="label">Load Reference Number (BOL)</div>
          <input id="loadRef" class="input" placeholder="e.g., LOAD-12345" />
        </div>

        <div>
          <div class="label">BOL PDF (Upload)</div>
          <input id="bolFile" class="input" type="file" accept="application/pdf" />
          <div class="text-xs muted mt-1">Only PDF allowed. Stored in bucket: load-documents (private).</div>
        </div>

        <div class="flex gap-2 pt-2">
          <button class="btn btn-primary" onclick="assignLoadAndUpload()">Create Load + Upload PDF</button>
          <button class="btn btn-outline" onclick="closeModal('loadModal')">Cancel</button>
        </div>

        <div id="loadModalStatus" class="text-sm muted"></div>
      </div>
    </div>
  </div>

  <script>
    // ============================
    // 1) SUPABASE CONFIG
    // ============================
    const SUPABASE_URL = "https://gtwpndodljngyiyfpzcy.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_u-lCgvNcQ910xc_n3oVnlQ_4DVBr";
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ============================
    // 2) SMALL UI HELPERS
    // ============================
    function showAlert(title, msg) {
      document.getElementById('alertTitle').textContent = title;
      document.getElementById('alertMsg').textContent = msg;
      document.getElementById('alert').classList.remove('hidden');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    function hideAlert() {
      document.getElementById('alert').classList.add('hidden');
    }
    function openModal(id) {
      document.getElementById(id).classList.remove('hidden');
    }
    function closeModal(id) {
      document.getElementById(id).classList.add('hidden');
    }
    function scrollToId(id) {
      document.getElementById(id).scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    function setSessionUI(user) {
      const pill = document.getElementById('sessionPill');
      const btnLogin = document.getElementById('btnLogin');
      const btnLogout = document.getElementById('btnLogout');

      if (user) {
        pill.textContent = `Logged in: ${user.email}`;
        pill.classList.remove('hidden');
        btnLogin.classList.add('hidden');
        btnLogout.classList.remove('hidden');
      } else {
        pill.textContent = '';
        pill.classList.add('hidden');
        btnLogin.classList.remove('hidden');
        btnLogout.classList.add('hidden');
      }
    }

    // ============================
    // 3) AUTH
    // ============================
    document.getElementById('btnLogin').addEventListener('click', () => openModal('loginModal'));
    document.getElementById('btnLogout').addEventListener('click', async () => {
      await supabaseClient.auth.signOut();
      setSessionUI(null);
      showAlert("Logged out", "You have been signed out.");
    });

    async function login() {
      const email = document.getElementById('loginEmail').value.trim().toLowerCase();
      const password = document.getElementById('loginPassword').value.trim();

      const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if (error) return showAlert("Login failed", error.message);

      closeModal('loginModal');
      setSessionUI(data.user);
      showAlert("Login successful", "You can now use Register, View Client Data, Contact Tracking, and Load Assignment.");
    }

    // Restore session on load
    (async () => {
      const { data } = await supabaseClient.auth.getSession();
      setSessionUI(data.session?.user ?? null);
    })();

    // ============================
    // 4) REGISTER SHIPPER / RECEIVER
    // ============================
    function formToPayload(form) {
      const fd = new FormData(form);
      const o = {};
      for (const [k, v] of fd.entries()) o[k] = (v ?? '').toString().trim() || null;
      // Optional defaults (if not set in DB)
      o.status = o.status ?? null;
      o.source = o.source ?? null;
      return o;
    }

    document.getElementById('shipperForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const { data: sessionData } = await supabaseClient.auth.getSession();
      if (!sessionData.session) return showAlert("Login required", "Please login first.");

      const payload = formToPayload(e.target);
      payload.client_type = payload.client_type ?? "shipper";
      payload.status = payload.status ?? "new";
      payload.source = payload.source ?? "website";

      const { error } = await supabaseClient.from('shippers').insert(payload);
      if (error) return showAlert("Save failed (Shipper)", error.message);

      e.target.reset();
      showAlert("Saved", "Shipper saved successfully.");
      await loadClients(); // refresh list for dropdowns/tables
    });

    document.getElementById('receiverForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const { data: sessionData } = await supabaseClient.auth.getSession();
      if (!sessionData.session) return showAlert("Login required", "Please login first.");

      const payload = formToPayload(e.target);
      payload.client_type = payload.client_type ?? "receiver";
      payload.status = payload.status ?? "new";
      payload.source = payload.source ?? "website";

      const { error } = await supabaseClient.from('receivers').insert(payload);
      if (error) return showAlert("Save failed (Receiver)", error.message);

      e.target.reset();
      showAlert("Saved", "Receiver saved successfully.");
      await loadClients();
    });

    // ============================
    // 5) VIEW CLIENTS (clients_view)
    // ============================
    let cachedClients = [];
    async function loadClients() {
      const { data: sessionData } = await supabaseClient.auth.getSession();
      if (!sessionData.session) return showAlert("Login required", "Please login first.");

      const { data, error } = await supabaseClient
        .from('clients_view')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) return showAlert("Load failed", error.message);

      cachedClients = data || [];
      renderClients();
      populateClientDropdown();
      showAlert("Loaded", `Loaded ${cachedClients.length} clients from clients_view.`);
    }

    function passesFilter(row) {
      const t = document.getElementById('filterClientType').value.trim().toLowerCase();
      const c = document.getElementById('filterCountry').value.trim().toLowerCase();
      const s = document.getElementById('filterState').value.trim().toLowerCase();
      const tr = document.getElementById('filterTrailer').value.trim().toLowerCase();

      if (t && (row.client_type || '').toLowerCase() !== t) return false;
      if (c && !(row.country || '').toLowerCase().includes(c)) return false;
      if (s && !(row.state_province || '').toLowerCase().includes(s)) return false;
      if (tr && !(row.preferred_trailer_type || '').toLowerCase().includes(tr)) return false;
      return true;
    }

    ['filterClientType','filterCountry','filterState','filterTrailer'].forEach(id => {
      document.getElementById(id).addEventListener('input', renderClients);
      document.getElementById(id).addEventListener('change', renderClients);
    });

    function renderClients() {
      const tbody = document.getElementById('clientsTbody');
      const rows = cachedClients.filter(passesFilter);

      tbody.innerHTML = rows.map(r => {
        const created = r.created_at ? new Date(r.created_at).toLocaleString() : '';
        return `
          <tr class="border-b">
            <td class="py-2 pr-4">${escapeHtml(r.client_type || '')}</td>
            <td class="py-2 pr-4 font-semibold">${escapeHtml(r.company_name || '')}</td>
            <td class="py-2 pr-4">${escapeHtml(r.contact_name || '')}</td>
            <td class="py-2 pr-4">${escapeHtml(r.phone || '')}</td>
            <td class="py-2 pr-4">${escapeHtml(r.email || '')}</td>
            <td class="py-2 pr-4">${escapeHtml(r.city || '')}</td>
            <td class="py-2 pr-4">${escapeHtml(r.state_province || '')}</td>
            <td class="py-2 pr-4">${escapeHtml(r.country || '')}</td>
            <td class="py-2 pr-4">${escapeHtml(r.preferred_trailer_type || '')}</td>
            <td class="py-2 pr-4">${escapeHtml(created)}</td>
          </tr>
        `;
      }).join('');
    }

    function populateClientDropdown() {
      const sel = document.getElementById('clientSelect');
      if (!cachedClients.length) return;

      sel.innerHTML = `<option value="">Select a client...</option>` + cachedClients.slice(0, 500).map(r => {
        // IMPORTANT: clients_view currently returns a single id for each row.
        // We store client_type + that id and later map to shipper_id or receiver_id.
        const value = JSON.stringify({ client_type: r.client_type, client_id: r.id, company_name: r.company_name || '' });
        const label = `${r.company_name || '(No name)'} — ${r.client_type}`;
        return `<option value='${escapeAttr(value)}'>${escapeHtml(label)}</option>`;
      }).join('');
    }

    // ============================
    // 6) CONTACT TRACKING
    // ============================
    let lastInsertedContactId = null;

    function getSelectedMethods() {
      const checked = Array.from(document.querySelectorAll('.cm')).filter(x => x.checked).map(x => x.value);
      return checked.join(', ');
    }

    async function saveContact() {
      const { data: sessionData } = await supabaseClient.auth.getSession();
      const user = sessionData.session?.user;
      if (!user) return showAlert("Login required", "Please login first.");

      const selValue = document.getElementById('clientSelect').value;
      if (!selValue) return showAlert("Missing client", "Please select a client.");

      const methods = getSelectedMethods();
      const remarks = document.getElementById('remarks').value.trim();

      if (!methods) return showAlert("Missing contact method", "Select at least one contact method.");
      if (!remarks) return showAlert("Missing remarks", "Please enter remarks.");

      const client = JSON.parse(selValue);
      const payload = {
        client_type: client.client_type,
        client_company_name: client.company_name || null,
        shipper_id: client.client_type === 'shipper' ? client.client_id : null,
        receiver_id: client.client_type === 'receiver' ? client.client_id : null,
        contact_methods: methods,
        remarks: remarks,
        // followup_status default is 'open' in DB; we can omit it here
        employee_name: user.email,
        employee_id: user.id
      };

      const { data, error } = await supabaseClient
        .from('contact_tracking')
        .insert(payload)
        .select('id')
        .single();

      if (error) return showAlert("Save failed (Contact)", error.message);

      lastInsertedContactId = data?.id ?? null;

      // Reset
      document.getElementById('remarks').value = '';
      document.querySelectorAll('.cm').forEach(x => x.checked = false);

      showAlert("Saved", `Contact recorded. (contact_tracking.id = ${lastInsertedContactId})`);
      await loadContactHistory();
    }

    async function loadContactHistory() {
      const { data: sessionData } = await supabaseClient.auth.getSession();
      if (!sessionData.session) return showAlert("Login required", "Please login first.");

      const { data, error } = await supabaseClient
        .from('contact_tracking')
        .select('id, created_at, client_type, client_company_name, contact_methods, remarks, followup_status, load_id')
        .order('created_at', { ascending: false })
        .limit(20);

      if (error) return showAlert("Load failed (History)", error.message);

      const container = document.getElementById('contactHistory');
      container.innerHTML = (data || []).map(r => {
        const d = r.created_at ? new Date(r.created_at).toLocaleString() : '';
        return `
          <div class="card p-3 bg-white">
            <div class="flex items-center justify-between gap-2">
              <div class="font-bold">#${r.id} <span class="pill ml-2">${escapeHtml(r.client_type || '')}</span></div>
              <div class="text-xs muted">${escapeHtml(d)}</div>
            </div>
            <div class="text-sm mt-1"><b>${escapeHtml(r.client_company_name || '')}</b></div>
            <div class="text-xs muted mt-1">Methods: ${escapeHtml(r.contact_methods || '')} • Status: ${escapeHtml(r.followup_status || '')} • Load: ${r.load_id ?? '—'}</div>
            <div class="text-sm mt-2">${escapeHtml(r.remarks || '')}</div>
          </div>
        `;
      }).join('') || `<div class="text-sm muted">No history found.</div>`;
    }

    // ============================
    // 7) LOAD ASSIGNMENT + PDF UPLOAD
    // ============================
    function openLoadAssignModal() {
      if (!lastInsertedContactId) {
        // You can still assign load without a contact, but linking is ideal.
        showAlert("Note", "Record a Contact first so we can link the load to that follow-up. You can still proceed, but linking is recommended.");
      }
      openModal('loadModal');
      document.getElementById('loadModalStatus').textContent = '';
      document.getElementById('loadRef').value = '';
      document.getElementById('bolFile').value = '';
    }

    async function assignLoadAndUpload() {
      const { data: sessionData } = await supabaseClient.auth.getSession();
      const user = sessionData.session?.user;
      if (!user) return showAlert("Login required", "Please login first.");

      const selValue = document.getElementById('clientSelect').value;
      if (!selValue) return showAlert("Missing client", "Please select a client first.");

      const client = JSON.parse(selValue);
      const loadRef = document.getElementById('loadRef').value.trim();
      const fileInput = document.getElementById('bolFile');
      const file = fileInput.files?.[0];

      if (!loadRef) return showAlert("Missing Load Reference", "Enter the load reference number (BOL).");
      if (!file) return showAlert("Missing PDF", "Please choose a PDF file to upload.");
      if (file.type !== "application/pdf") return showAlert("Invalid file type", "Only PDF files are allowed.");

      const statusEl = document.getElementById('loadModalStatus');
      statusEl.textContent = "Creating load record…";

      // Phase 1: create load row (without bol_pdf_path yet)
      const loadPayload = {
        load_reference_number: loadRef,
        client_type: client.client_type,
        shipper_id: client.client_type === 'shipper' ? client.client_id : null,
        receiver_id: client.client_type === 'receiver' ? client.client_id : null,
        status: "assigned",
        bol_pdf_uploaded_by: user.email
      };

      const { data: loadRow, error: loadErr } = await supabaseClient
        .from('loads')
        .insert(loadPayload)
        .select('id')
        .single();

      if (loadErr) return showAlert("Load create failed", loadErr.message);

      const loadId = loadRow.id;

      // Phase 2: upload PDF to Storage
      statusEl.textContent = "Uploading PDF to storage…";

      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, '0');

      const safeLoadRef = loadRef.replace(/[^a-zA-Z0-9_-]/g, '_');
      const storagePath = `bol/${yyyy}/${mm}/${safeLoadRef}.pdf`;

      const { error: upErr } = await supabaseClient
        .storage
        .from('load-documents')
        .upload(storagePath, file, { upsert: true, contentType: "application/pdf" });

      if (upErr) return showAlert("PDF upload failed", upErr.message);

      // Phase 3: update loads row with bol_pdf_path + filename
      statusEl.textContent = "Saving PDF path to database…";

      const { error: updErr } = await supabaseClient
        .from('loads')
        .update({
          bol_pdf_path: storagePath,
          bol_pdf_filename: file.name,
          bol_pdf_uploaded_at: new Date().toISOString()
        })
        .eq('id', loadId);

      if (updErr) return showAlert("Load update failed", updErr.message);

      // Phase 4: link to last contact (optional but recommended)
      if (lastInsertedContactId) {
        statusEl.textContent = "Linking load to last contact…";
        const { error: linkErr } = await supabaseClient
          .from('contact_tracking')
          .update({ load_id: loadId })
          .eq('id', lastInsertedContactId);

        if (linkErr) return showAlert("Contact link failed", linkErr.message);
      }

      statusEl.textContent = "Done.";
      closeModal('loadModal');
      showAlert("Success", `Load created (id=${loadId}), PDF uploaded, and linked to last contact.`);
      await loadContactHistory();
    }

    // ============================
    // 8) HTML ESCAPING
    // ============================
    function escapeHtml(str) {
      return (str ?? '').toString()
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }
    function escapeAttr(str) {
      // For JSON in option value
      return escapeHtml(str).replaceAll('\n', ' ');
    }

    // Optional: load contact history on first view if logged in
    setTimeout(async () => {
      const { data } = await supabaseClient.auth.getSession();
      if (data.session?.user) {
        await loadContactHistory();
      }
    }, 600);
  </script>
</body>
</html>
